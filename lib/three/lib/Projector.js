THREE.RenderableObject=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},THREE.RenderableFace=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.color=new THREE.Color,this.material=null,this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],this.z=0,this.renderOrder=0},THREE.RenderableVertex=function(){this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},THREE.RenderableLine=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0,this.renderOrder=0},THREE.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new THREE.Vector2,this.material=null,this.renderOrder=0},THREE.Projector=function(){var oe,ae,n,se,le,ce,pe,Ee,de,he,ue,me=[],fe=0,ve=[],r=0,t=[],i=0,o=[],a=0,Re=[],xe=0,ye={objects:[],lights:[],elements:[]},Te=new THREE.Vector3,He=new THREE.Vector4,u=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),m=new THREE.Box3,h=new Array(3),we=(new Array(4),new THREE.Matrix4),ge=new THREE.Matrix4,be=new THREE.Matrix4,Me=new THREE.Matrix3,Se=new THREE.Frustum,ze=new THREE.Vector4,Ve=new THREE.Vector4,je=(this.projectVector=function(e,r){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(r)},this.unprojectVector=function(e,r){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(r)},this.pickingRay=function(e,r){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")},new function(){var a=[],s=[],l=null,c=null,p=new THREE.Matrix3;function i(e){var r=e.position,t=e.positionWorld,i=e.positionScreen,r=(t.copy(r).applyMatrix4(ue),i.copy(t).applyMatrix4(ge),1/i.w);i.x*=r,i.y*=r,i.z*=r,e.visible=-1<=i.x&&i.x<=1&&-1<=i.y&&i.y<=1&&-1<=i.z&&i.z<=1}function E(e,r,t){return!0===e.visible||!0===r.visible||!0===t.visible||(h[0]=e.positionScreen,h[1]=r.positionScreen,h[2]=t.positionScreen,u.intersectsBox(m.setFromPoints(h)))}function d(e,r,t){return(t.positionScreen.x-e.positionScreen.x)*(r.positionScreen.y-e.positionScreen.y)-(t.positionScreen.y-e.positionScreen.y)*(r.positionScreen.x-e.positionScreen.x)<0}return{setObject:function(e){c=(l=e).material,p.getNormalMatrix(l.matrixWorld),s.length=a.length=0},projectVertex:i,checkTriangleVisibility:E,checkBackfaceCulling:d,pushVertex:function(e,r,t){(n=Oe()).position.set(e,r,t),i(n)},pushNormal:function(e,r,t){a.push(e,r,t)},pushUv:function(e,r){s.push(e,r)},pushLine:function(e,r){e=ve[e],r=ve[r],(pe=Le()).id=l.id,pe.v1.copy(e),pe.v2.copy(r),pe.z=(e.positionScreen.z+r.positionScreen.z)/2,pe.renderOrder=l.renderOrder,pe.material=l.material,ye.elements.push(pe)},pushTriangle:function(e,r,t){var i=ve[e],r=ve[r],t=ve[t];if(!1!==E(i,r,t)&&(c.side===THREE.DoubleSide||!0===d(i,r,t))){(le=Ce()).id=l.id,le.v1.copy(i),le.v2.copy(r),le.v3.copy(t),le.z=(i.positionScreen.z+r.positionScreen.z+t.positionScreen.z)/3,le.renderOrder=l.renderOrder,le.normalModel.fromArray(a,3*e),le.normalModel.applyMatrix3(p).normalize();for(var n=0;n<3;n++){var o=le.vertexNormalsModel[n];o.fromArray(a,3*arguments[n]),o.applyMatrix3(p).normalize(),le.uvs[n].fromArray(s,2*arguments[n])}le.vertexNormalsLength=3,le.material=l.material,ye.elements.push(le)}}}});function Oe(){var e;return se===r?(e=new THREE.RenderableVertex,ve.push(e),r++,se++,e):ve[se++]}function Ce(){var e;return ce===i?(e=new THREE.RenderableFace,t.push(e),i++,ce++,e):t[ce++]}function Le(){var e;return Ee===a?(e=new THREE.RenderableLine,o.push(e),a++,Ee++,e):o[Ee++]}function ke(e,r){return e.renderOrder!==r.renderOrder?e.renderOrder-r.renderOrder:e.z!==r.z?r.z-e.z:e.id!==r.id?e.id-r.id:0}this.projectScene=function(e,r,W,B){function F(e){var r;(oe=ae!==fe?me[ae++]:(r=new THREE.RenderableObject,me.push(r),fe++,ae++,r)).id=e.id,oe.object=e,Te.setFromMatrixPosition(e.matrixWorld),Te.applyMatrix4(ge),oe.z=Te.z,oe.renderOrder=e.renderOrder,ye.objects.push(oe)}he=Ee=ce=0,!(ye.elements.length=0)===e.autoUpdate&&e.updateMatrixWorld(),null===r.parent&&r.updateMatrixWorld(),we.copy(r.matrixWorldInverse.getInverse(r.matrixWorld)),ge.multiplyMatrices(r.projectionMatrix,we),Se.setFromMatrix(ge),ae=0,ye.objects.length=0,ye.lights.length=0,e.traverseVisible(function(e){e instanceof THREE.Light?ye.lights.push(e):e instanceof THREE.Mesh||e instanceof THREE.Line?!1===e.material.visible||!0===e.frustumCulled&&!1===Se.intersectsObject(e)||F(e):e instanceof THREE.Sprite&&(!1===e.material.visible||!0===e.frustumCulled&&!1===Se.intersectsSprite(e)||F(e))}),!0===W&&ye.objects.sort(ke);for(var t,i,n,o,a,s,l,c,p,P=0,A=ye.objects.length;P<A;P++){var E,d=ye.objects[P].object,h=d.geometry;if(je.setObject(d),ue=d.matrixWorld,se=0,d instanceof THREE.Mesh){if(h instanceof THREE.BufferGeometry){var u=h.attributes,D=h.groups;if(void 0!==u.position){for(var m=0,f=(N=u.position.array).length;m<f;m+=3)je.pushVertex(N[m],N[m+1],N[m+2]);if(void 0!==u.normal)for(var v=u.normal.array,m=0,f=v.length;m<f;m+=3)je.pushNormal(v[m],v[m+1],v[m+2]);if(void 0!==u.uv)for(var G=u.uv.array,m=0,f=G.length;m<f;m+=2)je.pushUv(G[m],G[m+1]);if(null!==h.index){var R=h.index.array;if(0<D.length)for(var I=0;I<D.length;I++)for(var U=D[I],m=U.start,f=U.start+U.count;m<f;m+=3)je.pushTriangle(R[m],R[m+1],R[m+2]);else for(m=0,f=R.length;m<f;m+=3)je.pushTriangle(R[m],R[m+1],R[m+2])}else for(m=0,f=N.length/3;m<f;m+=3)je.pushTriangle(m,m+1,m+2)}}else if(h instanceof THREE.Geometry){var x=h.vertices,q=h.faces,J=h.faceVertexUvs[0];Me.getNormalMatrix(ue);for(var K=(S=d.material)instanceof THREE.MultiMaterial,Q=!0==K?d.material:null,y=0,X=x.length;y<X;y++){var T=x[y];if(Te.copy(T),!0===S.morphTargets)for(var Y=h.morphTargets,Z=d.morphTargetInfluences,H=0,$=Y.length;H<$;H++){var w,g=Z[H];0!==g&&(w=Y[H].vertices[y],Te.x+=(w.x-T.x)*g,Te.y+=(w.y-T.y)*g,Te.z+=(w.z-T.z)*g)}je.pushVertex(Te.x,Te.y,Te.z)}for(var b=0,_=q.length;b<_;b++){var M=q[b],S=!0==K?Q.materials[M.materialIndex]:d.material;if(void 0!==S){var z=S.side,V=ve[M.a],j=ve[M.b],O=ve[M.c];if(!1!==je.checkTriangleVisibility(V,j,O)){var C=je.checkBackfaceCulling(V,j,O);if(z!==THREE.DoubleSide){if(z===THREE.FrontSide&&!1===C)continue;if(z===THREE.BackSide&&!0===C)continue}(le=Ce()).id=d.id,le.v1.copy(V),le.v2.copy(j),le.v3.copy(O),le.normalModel.copy(M.normal),!1!==C||z!==THREE.BackSide&&z!==THREE.DoubleSide||le.normalModel.negate(),le.normalModel.applyMatrix3(Me).normalize();for(var ee=M.vertexNormals,L=0,re=Math.min(ee.length,3);L<re;L++){var te=le.vertexNormalsModel[L];te.copy(ee[L]),!1!==C||z!==THREE.BackSide&&z!==THREE.DoubleSide||te.negate(),te.applyMatrix3(Me).normalize()}le.vertexNormalsLength=ee.length;var ie=J[b];if(void 0!==ie)for(var k=0;k<3;k++)le.uvs[k].copy(ie[k]);le.color=M.color,le.material=S,le.z=(V.positionScreen.z+j.positionScreen.z+O.positionScreen.z)/3,le.renderOrder=d.renderOrder,ye.elements.push(le)}}}}}else if(d instanceof THREE.Line){if(h instanceof THREE.BufferGeometry){if(void 0!==(u=h.attributes).position){for(var N,m=0,f=(N=u.position.array).length;m<f;m+=3)je.pushVertex(N[m],N[m+1],N[m+2]);if(null!==h.index)for(m=0,f=(R=h.index.array).length;m<f;m+=2)je.pushLine(R[m],R[m+1]);else for(var ne=d instanceof THREE.LineSegments?2:1,m=0,f=N.length/3-1;m<f;m+=ne)je.pushLine(m,m+1)}}else if(h instanceof THREE.Geometry){be.multiplyMatrices(ge,ue);x=d.geometry.vertices;if(0!==x.length){(V=Oe()).positionScreen.copy(x[0]).applyMatrix4(be);for(ne=d instanceof THREE.LineSegments?2:1,y=1,X=x.length;y<X;y++)(V=Oe()).positionScreen.copy(x[y]).applyMatrix4(be),0<(y+1)%ne||(j=ve[se-2],ze.copy(V.positionScreen),Ve.copy(j.positionScreen),!0==(n=Ve,p=c=l=s=a=o=void 0,o=0,a=1,s=(i=ze).z+i.w,l=n.z+n.w,c=-i.z+i.w,p=-n.z+n.w,0<=s&&0<=l&&0<=c&&0<=p||!(s<0&&l<0||c<0&&p<0||(s<0?o=Math.max(o,s/(s-l)):l<0&&(a=Math.min(a,s/(s-l))),c<0?o=Math.max(o,c/(c-p)):p<0&&(a=Math.min(a,c/(c-p))),a<o)||(i.lerp(n,o),n.lerp(i,1-a),0)))&&(ze.multiplyScalar(1/ze.w),Ve.multiplyScalar(1/Ve.w),(pe=Le()).id=d.id,pe.v1.positionScreen.copy(ze),pe.v2.positionScreen.copy(Ve),pe.z=Math.max(ze.z,Ve.z),pe.renderOrder=d.renderOrder,pe.material=d.material,d.material.vertexColors===THREE.VertexColors&&(pe.vertexColors[0].copy(d.geometry.colors[y]),pe.vertexColors[1].copy(d.geometry.colors[y-1])),ye.elements.push(pe)))}}}else d instanceof THREE.Sprite&&(He.set(ue.elements[12],ue.elements[13],ue.elements[14],1),He.applyMatrix4(ge),E=1/He.w,He.z*=E,-1<=He.z)&&He.z<=1&&(t=void 0,(de=he!==xe?Re[he++]:(t=new THREE.RenderableSprite,Re.push(t),xe++,he++,t)).id=d.id,de.x=He.x*E,de.y=He.y*E,de.z=He.z,de.renderOrder=d.renderOrder,de.object=d,de.rotation=d.rotation,de.scale.x=d.scale.x*Math.abs(de.x-(He.x+r.projectionMatrix.elements[0])/(He.w+r.projectionMatrix.elements[12])),de.scale.y=d.scale.y*Math.abs(de.y-(He.y+r.projectionMatrix.elements[5])/(He.w+r.projectionMatrix.elements[13])),de.material=d.material,ye.elements.push(de))}return!0===B&&ye.elements.sort(ke),ye}};