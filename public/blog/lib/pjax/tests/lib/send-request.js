var nativeOpen,tape=require("tape"),sendRequest=require("../../lib/send-request.js");"responseURL"in XMLHttpRequest.prototype||(nativeOpen=XMLHttpRequest.prototype.open,XMLHttpRequest.prototype.open=function(e,t){return this.responseURL=t,nativeOpen.apply(this,arguments)}),tape("test xhr request",function(e){var n="https://httpbin.org/get";e.test("- request is made, gets a result, and is cache-busted",function(t){var s=sendRequest(n,{cacheBust:!0},function(e){t.equal(s.responseURL.indexOf("?"),n.length,"XHR URL is cache-busted when configured to be");try{e=JSON.parse(e)}catch(e){t.fail("xhr doesn't get a JSON response")}t.same(typeof e,"object","xhr request get a result"),t.end()})}),e.test("- request is not cache-busted when configured not to be",function(e){var t=sendRequest(n,{},function(){e.equal(t.responseURL,n,"XHR URL is left untouched"),e.end()})}),e.end()}),tape("request headers are sent properly",function(t){sendRequest("https://httpbin.org/headers",{selectors:["div.pjax","div.container"]},function(e){e=JSON.parse(e).headers;t.equals(e["X-Requested-With"],"XMLHttpRequest","X-Requested-With header is set correctly"),t.equals(e["X-Pjax"],"true","X-PJAX header is set correctly"),t.equals(e["X-Pjax-Selectors"],'["div.pjax","div.container"]',"X-PJAX-Selectors header is set correctly"),t.end()})}),tape("HTTP status codes other than 200 are handled properly",function(s){sendRequest("https://httpbin.org/status/400",{},function(e,t){s.equals(e,null,"responseText is null"),s.equals(t.status,400,"HTTP status code is correct"),s.end()})}),tape.skip("XHR error is handled properly",function(t){sendRequest("https://encrypted.google.com/foobar",{},function(e){t.equals(e,null,"responseText is null"),t.end()})}),tape("POST body data is sent properly",function(t){var s=[{name:"test",value:"1"}];sendRequest("https://httpbin.org/post",{requestOptions:{requestMethod:"POST",requestParams:s}},function(e){e=JSON.parse(e);t.same(e.form[s[0].name],s[0].value,"requestParams were sent properly"),t.equals(e.headers["Content-Type"],"application/x-www-form-urlencoded","Content-Type header was set properly"),t.end()})}),tape("GET query data is sent properly",function(t){var s=[{name:"test",value:"1"}];sendRequest("https://httpbin.org/get",{requestOptions:{requestParams:s}},function(e){e=JSON.parse(e);t.same(e.args[s[0].name],s[0].value,"requestParams were sent properly"),t.end()})}),tape("XHR timeout is handled properly",function(t){sendRequest("https://httpbin.org/delay/5",{timeout:1e3},function(e){t.equals(e,null,"responseText is null"),t.end()})});