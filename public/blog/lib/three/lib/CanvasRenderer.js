THREE.SpriteCanvasMaterial=function(e){THREE.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new THREE.Color(16777215),this.program=function(e,t){},this.setValues(e)},THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial,THREE.SpriteCanvasMaterial.prototype.clone=function(){var e=new THREE.SpriteCanvasMaterial;return e.copy(this),e.color.copy(this.color),e.program=this.program,e},THREE.CanvasRenderer=function(e){console.log("THREE.CanvasRenderer",THREE.REVISION),e=e||{};var D,F,N,O,A,I,G,U,q,J,K,Q,de,he,fe,me,ve,X=this,xe=new THREE.Projector,o=void 0!==e.canvas?e.canvas:document.createElement("canvas"),Y=o.width,Z=o.height,$=Math.floor(Y/2),_=Math.floor(Z/2),ye=0,Re=0,Te=Y,ge=Z,n=1,ee=o.getContext("2d",{alpha:!0===e.alpha}),i=new THREE.Color(0),r=!0===e.alpha?0:1,a=1,s=0,l=null,c=null,p=null,E=null,d=null,t=[],te=(new THREE.RenderableVertex,new THREE.RenderableVertex,new THREE.Color),ue=(new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color),Se=new THREE.Color,He=new THREE.Color,ie={},oe=new THREE.Box2,ne=new THREE.Box2,re=new THREE.Box2,we=new THREE.Color,Ce=new THREE.Color,Me=new THREE.Color,be=new THREE.Vector3,Le=new THREE.Vector3,ae=new THREE.Vector3,se=new THREE.Matrix3;function Be(e,t,i,o){je(t),ke(i),De(o),pe(e.getStyle()),ee.stroke(),re.expandByScalar(2*t)}function Pe(e){Ee(e.getStyle()),ee.fill()}function Ve(e){var t,i,o,n,r,a,s;return 0===e.version||e instanceof THREE.CompressedTexture||e instanceof THREE.DataTexture?{canvas:void 0,version:e.version}:!1===(t=e.image).complete?{canvas:void 0,version:0}:(i=e.wrapS===THREE.RepeatWrapping||e.wrapS===THREE.MirroredRepeatWrapping,o=e.wrapT===THREE.RepeatWrapping||e.wrapT===THREE.MirroredRepeatWrapping,a=e.wrapS===THREE.MirroredRepeatWrapping,s=e.wrapT===THREE.MirroredRepeatWrapping,(n=document.createElement("canvas")).width=t.width*(a?2:1),n.height=t.height*(s?2:1),(r=n.getContext("2d")).setTransform(1,0,0,-1,0,t.height),r.drawImage(t,0,0),!0==a&&(r.setTransform(-1,0,0,-1,t.width,t.height),r.drawImage(t,-t.width,0)),!0==s&&(r.setTransform(1,0,0,1,0,0),r.drawImage(t,0,t.height)),!0==a&&!0==s&&(r.setTransform(-1,0,0,1,t.width,0),r.drawImage(t,-t.width,t.height)),a="no-repeat",!0==i&&!0==o?a="repeat":!0==i?a="repeat-x":!0==o&&(a="repeat-y"),s=ee.createPattern(n,a),e.onUpdate&&e.onUpdate(e),{canvas:s,version:e.version})}function We(e,t,i,o,n,r,a,s,l,c,p,E,d){var h,f,m=ie[d.id];void 0!==m&&m.version===d.version||(m=Ve(d),ie[d.id]=m),void 0===m.canvas?(Ee("rgba( 0, 0, 0, 1)"),ee.fill()):(Ee(m.canvas),m=d.offset.x/d.repeat.x,h=d.offset.y/d.repeat.y,l=(l+m)*(f=d.image.width*d.repeat.x),c=(c+h)*(d=d.image.height*d.repeat.y),p=(p+m)*f,E=(E+h)*d,i-=e,o-=t,n-=e,r-=t,0!=(m=(l-=a=(a+m)*f)*(E-=s=(s+h)*d)-(p-=a)*(c-=s))&&(e=e-(h=(E*i-c*n)*(f=1/m))*a-(d=(l*n-p*i)*f)*s,i=t-(m=(E*o-c*r)*f)*a-(n=(l*r-p*o)*f)*s,ee.save(),ee.transform(h,m,d,n,e,i),ee.fill(),ee.restore()))}function ze(e,t,i){var o=t.x-e.x,n=t.y-e.y,r=o*o+n*n;0!=r&&(n*=i=i/Math.sqrt(r),t.x+=o*=i,t.y+=n,e.x-=o,e.y-=n)}function le(e){a!==e&&(ee.globalAlpha=e,a=e)}function ce(e){s!==e&&(e===THREE.NormalBlending?ee.globalCompositeOperation="source-over":e===THREE.AdditiveBlending?ee.globalCompositeOperation="lighter":e===THREE.SubtractiveBlending?ee.globalCompositeOperation="darker":e===THREE.MultiplyBlending&&(ee.globalCompositeOperation="multiply"),s=e)}function je(e){p!==e&&(ee.lineWidth=e,p=e)}function ke(e){E!==e&&(ee.lineCap=e,E=e)}function De(e){d!==e&&(ee.lineJoin=e,d=e)}function pe(e){l!==e&&(ee.strokeStyle=e,l=e)}function Ee(e){c!==e&&(ee.fillStyle=e,c=e)}function Fe(e){t.length!==e.length&&(ee.setLineDash(e),t=e)}void 0===ee.setLineDash&&(ee.setLineDash=function(){}),this.domElement=o,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.getContext=function(){return ee},this.getContextAttributes=function(){return ee.getContextAttributes()},this.getPixelRatio=function(){return n},this.setPixelRatio=function(e){void 0!==e&&(n=e)},this.setSize=function(e,t,i){Y=e*n,Z=t*n,o.width=Y,o.height=Z,$=Math.floor(Y/2),_=Math.floor(Z/2),!1!==i&&(o.style.width=e+"px",o.style.height=t+"px"),oe.min.set(-$,-_),oe.max.set($,_),ne.min.set(-$,-_),ne.max.set($,_),a=1,s=0,d=E=p=c=l=null,this.setViewport(0,0,e,t)},this.setViewport=function(e,t,i,o){ye=e*n,Re=t*n,Te=i*n,ge=o*n},this.setScissor=function(){},this.setScissorTest=function(){},this.setClearColor=function(e,t){i.set(e),r=void 0!==t?t:1,ne.min.set(-$,-_),ne.max.set($,_)},this.setClearColorHex=function(e,t){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(e,t)},this.getClearColor=function(){return i},this.getClearAlpha=function(){return r},this.getMaxAnisotropy=function(){return 0},this.clear=function(){!1===ne.isEmpty()&&(ne.intersect(oe),ne.expandByScalar(2),ne.min.x=ne.min.x+$,ne.min.y=-ne.min.y+_,ne.max.x=ne.max.x+$,ne.max.y=-ne.max.y+_,r<1&&ee.clearRect(0|ne.min.x,0|ne.max.y,ne.max.x-ne.min.x|0,ne.min.y-ne.max.y|0),0<r&&(ce(THREE.NormalBlending),le(1),Ee("rgba("+Math.floor(255*i.r)+","+Math.floor(255*i.g)+","+Math.floor(255*i.b)+","+r+")"),ee.fillRect(0|ne.min.x,0|ne.max.y,ne.max.x-ne.min.x|0,ne.min.y-ne.max.y|0)),ne.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(e,t){if(t instanceof THREE.Camera==!1)console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");else{var i=e.background;i&&i.isColor?(Ee("rgb("+Math.floor(255*i.r)+","+Math.floor(255*i.g)+","+Math.floor(255*i.b)+")"),ee.fillRect(0,0,Y,Z)):!0===this.autoClear&&this.clear(),X.info.render.vertices=0,X.info.render.faces=0,ee.setTransform(Te/Y,0,0,-ge/Z,ye,Z-Re),ee.translate($,_),D=xe.projectScene(e,t,this.sortObjects,this.sortElements),F=D.elements,N=D.lights,se.getNormalMatrix(t.matrixWorldInverse),we.setRGB(0,0,0),Ce.setRGB(0,0,0),Me.setRGB(0,0,0);for(var o=0,n=N.length;o<n;o++){var r=N[o],a=r.color;r instanceof THREE.AmbientLight?we.add(a):r instanceof THREE.DirectionalLight?Ce.add(a):r instanceof THREE.PointLight&&Me.add(a)}for(var s,l,c=0,k=F.length;c<k;c++){var p=F[c],E=p.material;if(void 0!==E&&0!==E.opacity){if(re.makeEmpty(),p instanceof THREE.RenderableSprite){(O=p).x*=$,O.y*=_,x=T=R=y=g=v=m=f=h=d=void 0;var d=O,h=p,f=E;le(f.opacity),ce(f.blending);var m=h.scale.x*$,h=h.scale.y*_,v=.5*Math.sqrt(m*m+h*h);re.min.set(d.x-v,d.y-v),re.max.set(d.x+v,d.y+v),f instanceof THREE.SpriteMaterial?null!==(v=f.map)?(void 0!==(g=ie[v.id])&&g.version===v.version||(g=Ve(v),ie[v.id]=g),void 0!==g.canvas&&(Ee(g.canvas),g=v.image,y=g.width*v.offset.x,R=g.height*v.offset.y,T=g.width*v.repeat.x,g=g.height*v.repeat.y,v=m/T,x=h/g,ee.save(),ee.translate(d.x,d.y),0!==f.rotation&&ee.rotate(f.rotation),ee.translate(-m/2,-h/2),ee.scale(v,x),ee.translate(-y,-R),ee.fillRect(y,R,T,g),ee.restore())):(Ee(f.color.getStyle()),ee.save(),ee.translate(d.x,d.y),0!==f.rotation&&ee.rotate(f.rotation),ee.scale(m,-h),ee.fillRect(-.5,-.5,1,1),ee.restore()):f instanceof THREE.SpriteCanvasMaterial&&(pe(f.color.getStyle()),Ee(f.color.getStyle()),ee.save(),ee.translate(d.x,d.y),0!==f.rotation&&ee.rotate(f.rotation),ee.scale(m,h),f.program(ee),ee.restore())}else if(p instanceof THREE.RenderableLine){if(O=p.v1,A=p.v2,O.positionScreen.x*=$,O.positionScreen.y*=_,A.positionScreen.x*=$,A.positionScreen.y*=_,re.setFromPoints([O.positionScreen,A.positionScreen]),!0===oe.intersectsBox(re)){g=T=R=y=x=v=void 0;var v=O,x=A,y=p,R=E;if(le(R.opacity),ce(R.blending),ee.beginPath(),ee.moveTo(v.positionScreen.x,v.positionScreen.y),ee.lineTo(x.positionScreen.x,x.positionScreen.y),R instanceof THREE.LineBasicMaterial){if(je(R.linewidth),ke(R.linecap),De(R.linejoin),R.vertexColors!==THREE.VertexColors)pe(R.color.getStyle());else{var T=y.vertexColors[0].getStyle(),y=y.vertexColors[1].getStyle();if(T===y)pe(T);else{try{var g=ee.createLinearGradient(v.positionScreen.x,v.positionScreen.y,x.positionScreen.x,x.positionScreen.y);g.addColorStop(0,T),g.addColorStop(1,y)}catch(e){g=T}pe(g)}}ee.stroke(),re.expandByScalar(2*R.linewidth)}else R instanceof THREE.LineDashedMaterial&&(je(R.linewidth),ke(R.linecap),De(R.linejoin),pe(R.color.getStyle()),Fe([R.dashSize,R.gapSize]),ee.stroke(),re.expandByScalar(2*R.linewidth),Fe([]))}}else if(p instanceof THREE.RenderableFace){if(O=p.v1,A=p.v2,I=p.v3,O.positionScreen.z<-1||1<O.positionScreen.z)continue;if(A.positionScreen.z<-1||1<A.positionScreen.z)continue;if(I.positionScreen.z<-1||1<I.positionScreen.z)continue;if(O.positionScreen.x*=$,O.positionScreen.y*=_,A.positionScreen.x*=$,A.positionScreen.y*=_,I.positionScreen.x*=$,I.positionScreen.y*=_,0<E.overdraw&&(ze(O.positionScreen,A.positionScreen,E.overdraw),ze(A.positionScreen,I.positionScreen,E.overdraw),ze(I.positionScreen,O.positionScreen,E.overdraw)),re.setFromPoints([O.positionScreen,A.positionScreen,I.positionScreen]),!0===oe.intersectsBox(re)){d=O,m=A,h=I,f=0,s=1,l=2,p=p,E=E,X.info.render.vertices+=3,X.info.render.faces++,le(E.opacity),ce(E.blending),I=d.positionScreen.x,G=d.positionScreen.y,U=m.positionScreen.x,q=m.positionScreen.y,J=h.positionScreen.x,K=h.positionScreen.y,M=C=w=H=S=u=void 0;var u=I,S=G,H=U,w=q,C=J,M=K;if(ee.beginPath(),ee.moveTo(u,S),ee.lineTo(H,w),ee.lineTo(C,M),ee.closePath(),(E instanceof THREE.MeshLambertMaterial||E instanceof THREE.MeshPhongMaterial)&&null===E.map){ue.copy(E.color),Se.copy(E.emissive),E.vertexColors===THREE.FaceColors&&ue.multiply(p.color),te.copy(we),Le.copy(d.positionWorld).add(m.positionWorld).add(h.positionWorld).divideScalar(3);{b=void 0;L=void 0;B=void 0;P=void 0;V=void 0;j=void 0;W=void 0;z=void 0;var b=Le;var L=p.normalModel;var B=te;for(var P=0,V=N.length;P<V;P++){var W,z,j=N[P];He.copy(j.color),j instanceof THREE.DirectionalLight?(W=be.setFromMatrixPosition(j.matrixWorld).normalize(),(z=L.dot(W))<=0||(z*=j.intensity,B.add(He.multiplyScalar(z)))):j instanceof THREE.PointLight&&(W=be.setFromMatrixPosition(j.matrixWorld),(z=L.dot(be.subVectors(W,b).normalize()))<=0||0!=(z*=0==j.distance?1:1-Math.min(b.distanceTo(W)/j.distance,1))&&(z*=j.intensity,B.add(He.multiplyScalar(z))))}}te.multiply(ue).add(Se),!0===E.wireframe?Be(te,E.wireframeLinewidth,E.wireframeLinecap,E.wireframeLinejoin):Pe(te)}else E instanceof THREE.MeshBasicMaterial||E instanceof THREE.MeshLambertMaterial||E instanceof THREE.MeshPhongMaterial?null!==E.map?E.map.mapping===THREE.UVMapping&&(Q=p.uvs,We(I,G,U,q,J,K,Q[f].x,Q[f].y,Q[s].x,Q[s].y,Q[l].x,Q[l].y,E.map)):null!==E.envMap?E.envMap.mapping===THREE.SphericalReflectionMapping&&(ae.copy(p.vertexNormalsModel[f]).applyMatrix3(se),Q=.5*ae.x+.5,de=.5*ae.y+.5,ae.copy(p.vertexNormalsModel[s]).applyMatrix3(se),he=.5*ae.x+.5,fe=.5*ae.y+.5,ae.copy(p.vertexNormalsModel[l]).applyMatrix3(se),me=.5*ae.x+.5,ve=.5*ae.y+.5,We(I,G,U,q,J,K,Q,de,he,fe,me,ve,E.envMap)):(te.copy(E.color),E.vertexColors===THREE.FaceColors&&te.multiply(p.color),!0===E.wireframe?Be(te,E.wireframeLinewidth,E.wireframeLinecap,E.wireframeLinejoin):Pe(te)):(E instanceof THREE.MeshNormalMaterial?(ae.copy(p.normalModel).applyMatrix3(se),te.setRGB(ae.x,ae.y,ae.z).multiplyScalar(.5).addScalar(.5)):te.setRGB(1,1,1),!0===E.wireframe?Be(te,E.wireframeLinewidth,E.wireframeLinecap,E.wireframeLinejoin):Pe(te))}}ne.union(re)}}ee.setTransform(1,0,0,1,0,0)}}};