window.addEventListener("DOMContentLoaded",()=>{let r=!1,n,o=!0,e=CONFIG.path,l=(0===e.length?e="search.xml":/json$/i.test(e)&&(o=!1),CONFIG.root+e),t=document.getElementById("search-input"),s=document.getElementById("search-result"),f=(e,t,r)=>{var n=e.length;if(0===n)return[];let o=0;var l,s=[];for(r||(t=t.toLowerCase(),e=e.toLowerCase());-1<(l=t.indexOf(e,o));)s.push({position:l,word:e}),o=l+n;return s},v=(e,t,r,n)=>{var o=r[r.length-1];let l=o.position,s=o.word;var a=[];let i=0;for(;l+s.length<=t&&0!==r.length;){s===n&&i++,a.push({position:l,length:s.length});var c=l+s.length;for(r.pop();0!==r.length&&(o=r[r.length-1],l=o.position,s=o.word,c>l);)r.pop()}return{hits:a,start:e,end:t,searchTextCount:i}},C=(r,e)=>{let n="",o=e.start;return e.hits.forEach(e=>{n+=r.substring(o,e.position);var t=e.position+e.length;n+=`<b class="search-keyword">${r.substring(e.position,t)}</b>`,o=t}),n+=r.substring(o,e.end)},a=()=>{let d=t.value.trim().toLowerCase(),g=d.split(/[-\s]+/),y=(1<g.length&&g.push(d),[]);if(0<d.length&&n.forEach(e=>{if(e.title){let n=0;var i=e.title.trim();let t=i.toLowerCase(),o=e.content?e.content.trim().replace(/<[^>]+>/g,""):"",r=(o=CONFIG.localsearch.unescape?(c=o,String(c).replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&#x3A;/g,":").replace(/&#(\d+);/g,(e,t)=>String.fromCharCode(t)).replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")):o).toLowerCase(),l=decodeURIComponent(e.url).replace(/\/{2,}/g,"/"),s=[],a=[];if(g.forEach(e=>{s=s.concat(f(e,t,!1)),a=a.concat(f(e,r,!1))}),0<s.length||0<a.length){var c=s.length+a.length,e=([s,a].forEach(e=>{e.sort((e,t)=>t.position!==e.position?t.position-e.position:e.word.length-t.word.length)}),[]);0!==s.length&&(p=v(0,i.length,s,d),n+=p.searchTextCountInSlice,e.push(p));let r=[];for(;0!==a.length;){var h=a[a.length-1],u=h.position,h=h.word;let e=u-20,t=u+80;e<0&&(e=0),(t=t<u+h.length?u+h.length:t)>o.length&&(t=o.length);u=v(e,t,a,d);n+=u.searchTextCountInSlice,r.push(u)}r.sort((e,t)=>e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start);var p=parseInt(CONFIG.localsearch.top_n_per_article,10);0<=p&&(r=r.slice(0,p));let t="";t+=0!==e.length?`<li><a href="${l}" class="search-result-title">${C(i,e[0])}</a>`:`<li><a href="${l}" class="search-result-title">${i}</a>`,r.forEach(e=>{t+=`<a href="${l}"><p class="search-result">${C(o,e)}...</p></a>`}),t+="</li>",y.push({item:t,searchTextCount:n,hitCount:c,id:y.length})}}}),1===g.length&&""===g[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x"></i></div>';else if(0===y.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>';else{y.sort((e,t)=>e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id);let t='<ul class="search-result-list">';y.forEach(e=>{t+=e.item}),t+="</ul>",s.innerHTML=t,window.pjax&&window.pjax.refresh(s)}},i=t=>{fetch(l).then(e=>e.text()).then(e=>{r=!0,n=o?[...(new DOMParser).parseFromString(e,"text/xml").querySelectorAll("entry")].map(e=>({title:e.querySelector("title").innerHTML,content:e.querySelector("content").innerHTML,url:e.querySelector("url").innerHTML})):JSON.parse(e),document.querySelector(".search-pop-overlay").innerHTML="",document.body.style.overflow="",t&&t()})},c=(CONFIG.localsearch.preload&&i(),()=>{document.body.style.overflow="hidden",document.querySelector(".search-pop-overlay").style.display="block",document.querySelector(".popup").style.display="block",document.getElementById("search-input").focus()}),h=("auto"===CONFIG.localsearch.trigger?t.addEventListener("input",a):(document.querySelector(".search-icon").addEventListener("click",a),t.addEventListener("keypress",e=>{13===e.keyCode&&a()})),document.querySelector(".popup-trigger").addEventListener("click",()=>{!1===r?(document.querySelector(".search-pop-overlay").style.display="",document.querySelector(".search-pop-overlay").innerHTML='<div class="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div>',i(c)):c()}),()=>{document.body.style.overflow="",document.querySelector(".search-pop-overlay").style.display="none",document.querySelector(".popup").style.display="none"});document.querySelector(".search-pop-overlay").addEventListener("click",h),document.querySelector(".popup-btn-close").addEventListener("click",h),window.addEventListener("pjax:success",h),window.addEventListener("keyup",e=>{27===e.which&&h()})});